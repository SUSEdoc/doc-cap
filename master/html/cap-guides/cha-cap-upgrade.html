<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Upgrading SUSE Cloud Application Platform | Deployment, Administration, and User Guides | SUSE Cloud Application Platform 2.1.0</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" /><meta name="generator" content="DAPS 3.0.0 (https://opensuse.github.io/daps) using SUSE XSL Stylesheets 2.0.17 (based on DocBook XSL Stylesheets 1.79.2) - chunked" /><meta name="product-name" content="SUSE Cloud Application Platform" /><meta name="product-number" content="2.1.0" /><meta name="book-title" content="Deployment, Administration, and User Guides" /><meta name="chapter-title" content="Chapter 13. Upgrading SUSE Cloud Application Platform" /><meta name="description" content="SUSE Cloud Application Platform upgrades are delivered as container images from the SUSE registry and applied with Helm." /><meta name="tracker-url" content="https://github.com/SUSE/doc-cap/issues/new" /><meta name="tracker-type" content="gh" /><meta name="tracker-gh-assignee" content="btat" /><meta name="tracker-gh-labels" content="bug,low priority" /><link rel="home" href="index.html" title="SUSE Cloud Application Platform 2.1.0 Documentation" /><link rel="up" href="part-cap-administration.html" title="Part III. SUSE Cloud Application Platform Administration" /><link rel="prev" href="part-cap-administration.html" title="Part III. SUSE Cloud Application Platform Administration" /><link rel="next" href="cha-cap-configuration-changes.html" title="Chapter 14. Configuration Changes" />
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css"></link>');
}
else {
  document.write('<link rel="stylesheet" type="text/css" href="static/css/fonts-onlylocal.css"></link>');
}

</script><noscript><link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css" /></noscript><script src="static/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-navigation">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><div id="_outer-wrap"><div id="_white-bg" style="background-color: #FABEBE;"><div id="_header"><div id="_logo"><img src="static/images/logo.png" alt="Logo" /></div><div class="crumbs"><a class="book-link" href="index.html" title="SUSE Cloud Application Platform 2.1.0 Documentation"><span class="book-icon">SUSE Cloud Application Platform 2.1.0 Documentation</span></a><span> › </span><a class="crumb" href="book-cap-guides.html">Deployment, Administration, and User Guides</a><span> › </span><a class="crumb" href="part-cap-administration.html">SUSE Cloud Application Platform Administration</a><span> › </span><a class="crumb" href="cha-cap-upgrade.html">Upgrading SUSE Cloud Application Platform</a></div><div class="clearme"></div></div></div><div id="_toolbar-wrap"><div id="_toolbar"><div id="_toc-area" class="inactive"><a id="_toc-area-button" class="tool" title="Contents" accesskey="c" href="index.html"><span class="tool-spacer"><span class="toc-icon">Contents</span><span class="clearme"></span></span><span class="tool-label">Contents</span></a><div class="active-contents bubble-corner"></div><div class="active-contents bubble"><div class="bubble-container"><h6>Deployment, Administration, and User Guides</h6><div id="_bubble-toc"><ol><li class="inactive"><a href="preface-deployment.html"><span class="number"> </span><span class="name">About This Guide</span></a></li><li class="inactive"><a href="part-cap-overview.html"><span class="number">I </span><span class="name">Overview of SUSE Cloud Application Platform</span></a><ol><li class="inactive"><a href="cha-cap-overview.html"><span class="number">1 </span><span class="name">About SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-depl-kube-requirements.html"><span class="number">2 </span><span class="name">Other Kubernetes Systems</span></a></li></ol></li><li class="inactive"><a href="part-cap-deployment.html"><span class="number">II </span><span class="name">Deploying SUSE Cloud Application Platform</span></a><ol><li class="inactive"><a href="cha-cap-depl-notes.html"><span class="number">3 </span><span class="name">Deployment and Administration Notes</span></a></li><li class="inactive"><a href="cha-cap-depl-caasp.html"><span class="number">4 </span><span class="name">Deploying SUSE Cloud Application Platform on SUSE CaaS Platform</span></a></li><li class="inactive"><a href="cha-cap-depl-aks.html"><span class="number">5 </span><span class="name">Deploying SUSE Cloud Application Platform on Microsoft Azure Kubernetes Service (AKS)</span></a></li><li class="inactive"><a href="cha-cap-depl-eks.html"><span class="number">6 </span><span class="name">Deploying SUSE Cloud Application Platform on Amazon Elastic Kubernetes Service (EKS)</span></a></li><li class="inactive"><a href="cha-cap-depl-gke.html"><span class="number">7 </span><span class="name">Deploying SUSE Cloud Application Platform on Google Kubernetes Engine (GKE)</span></a></li><li class="inactive"><a href="cha-cap-install-stratos.html"><span class="number">8 </span><span class="name">Installing the Stratos Web Console</span></a></li><li class="inactive"><a href="cha-cap-depl-eirini.html"><span class="number">9 </span><span class="name">Eirini</span></a></li><li class="inactive"><a href="cha-cap-depl-terraform.html"><span class="number">10 </span><span class="name">Deploying SUSE Cloud Application Platform Using Terraform</span></a></li><li class="inactive"><a href="cha-cap-depl-air-gap-registry.html"><span class="number">11 </span><span class="name">Setting Up a Registry for an Air Gapped Environment</span></a></li><li class="inactive"><a href="cha-cap-depl-private-registry.html"><span class="number">12 </span><span class="name">SUSE Private Registry</span></a></li></ol></li><li class="inactive"><a href="part-cap-administration.html"><span class="number">III </span><span class="name">SUSE Cloud Application Platform Administration</span></a><ol><li class="inactive"><a href="cha-cap-upgrade.html"><span class="number">13 </span><span class="name">Upgrading SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-configuration-changes.html"><span class="number">14 </span><span class="name">Configuration Changes</span></a></li><li class="inactive"><a href="cha-cap-create-admin-user.html"><span class="number">15 </span><span class="name">Creating Admin Users</span></a></li><li class="inactive"><a href="cha-cap-manage-passwords.html"><span class="number">16 </span><span class="name">Managing Passwords</span></a></li><li class="inactive"><a href="cha-cap-uaa-ui.html"><span class="number">17 </span><span class="name">Accessing the UAA User Interface</span></a></li><li class="inactive"><a href="cha-cap-memory-limits.html"><span class="number">18 </span><span class="name">Container Memory Limits and Requests</span></a></li><li class="inactive"><a href="cha-cap-ccdb-secret-rotation.html"><span class="number">19 </span><span class="name">Cloud Controller Database Secret Rotation</span></a></li><li class="inactive"><a href="cha-cap-secrets-rotation.html"><span class="number">20 </span><span class="name">Rotating Automatically Generated Secrets</span></a></li><li class="inactive"><a href="cha-cap-backup-restore.html"><span class="number">21 </span><span class="name">Backup and Restore</span></a></li><li class="inactive"><a href="cha-cap-service-brokers.html"><span class="number">22 </span><span class="name">Service Brokers</span></a></li><li class="inactive"><a href="cha-cap-app-autoscaler.html"><span class="number">23 </span><span class="name">App-AutoScaler</span></a></li><li class="inactive"><a href="cha-cap-credhub.html"><span class="number">24 </span><span class="name">Integrating CredHub with SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-buildpacks.html"><span class="number">25 </span><span class="name">Buildpacks</span></a></li></ol></li><li class="inactive"><a href="part-cap-user-guide.html"><span class="number">IV </span><span class="name">SUSE Cloud Application Platform User Guide</span></a><ol><li class="inactive"><a href="cha-cap-cf-cli.html"><span class="number">26 </span><span class="name">Deploying and Managing Applications with the Cloud Foundry Client</span></a></li></ol></li><li class="inactive"><a href="part-cap-troubleshooting.html"><span class="number">V </span><span class="name">Troubleshooting</span></a><ol><li class="inactive"><a href="cha-cap-depl-troubleshooting.html"><span class="number">27 </span><span class="name">Troubleshooting</span></a></li></ol></li><li class="inactive"><a href="bk01apa.html"><span class="number">A </span><span class="name">Appendix</span></a></li><li class="inactive"><a href="bk01apb.html"><span class="number">B </span><span class="name">GNU Licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_nav-area" class="inactive"><div class="tool"><span class="nav-inner"><span class="tool-label">Navigation</span><a accesskey="p" class="tool-spacer" title="Part III. SUSE Cloud Application Platform Administration" href="part-cap-administration.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 14. Configuration Changes" href="cha-cap-configuration-changes.html"><span class="next-icon">→</span></a></span></div></div></div></div><div id="_fixed-header-wrap" style="background-color: #FABEBE;" class="inactive"><div id="_fixed-header"><div class="crumbs"><a class="book-link" href="index.html" title="SUSE Cloud Application Platform 2.1.0 Documentation"><span class="book-icon">SUSE Cloud Application Platform 2.1.0 Documentation</span></a><span> › </span><a class="crumb" href="book-cap-guides.html">Deployment, Administration, and User Guides</a><span> › </span><a class="crumb" href="part-cap-administration.html">SUSE Cloud Application Platform Administration</a><span> › </span><a class="crumb" href="cha-cap-upgrade.html">Upgrading SUSE Cloud Application Platform</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="button"><a accesskey="p" class="tool-spacer" title="Part III. SUSE Cloud Application Platform Administration" href="part-cap-administration.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 14. Configuration Changes" href="cha-cap-configuration-changes.html"><span class="next-icon">→</span></a></div><div class="clearme"></div></div><div class="clearme"></div></div></div><div id="_content" class="draft "><div class="documentation"><div class="chapter " id="cha-cap-upgrade"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname ">SUSE Cloud Application Platform</span> <span class="productnumber ">2.1.0</span></div><div><h2 class="title"><span class="number">13 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Upgrading SUSE Cloud Application Platform</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="cha-cap-upgrade.html#sec-cap-upgrade-considerations"><span class="number">13.1 </span><span class="name">Important Considerations</span></a></span></dt><dt><span class="sect1"><a href="cha-cap-upgrade.html#sec-cap-update"><span class="number">13.2 </span><span class="name">Upgrading SUSE Cloud Application Platform</span></a></span></dt></dl></div></div><p>
  SUSE Cloud Application Platform upgrades are delivered as container images from the SUSE
  registry and applied with Helm.
 </p><p>
   For additional upgrade information, always review the release notes
   published at
   <a class="link" href="https://www.suse.com/releasenotes/x86_64/SUSE-CAP/2/" target="_blank">https://www.suse.com/releasenotes/x86_64/SUSE-CAP/2/</a>.
 </p><div class="sect1 " id="sec-cap-upgrade-considerations"><div class="titlepage"><div><div><h2 class="title"><span class="number">13.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Important Considerations</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#sec-cap-upgrade-considerations">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span>sec-cap-upgrade-considerations</li></ul></div></div></div></div><p>
   Before performing an upgrade, be sure to take note of the following:
  </p><div class="variablelist "><dl class="variablelist"><dt id="id-1.3.5.3.4.3.1"><span class="term ">Perform Upgrades in Sequence</span></dt><dd><p>
      Cloud Application Platform only supports upgrading releases in sequential order. If there are
      any intermediate releases between your current release and your target
      release, they must be installed. Skipping releases is not supported.
     </p></dd><dt id="id-1.3.5.3.4.3.2"><span class="term ">Preserve Helm Value Changes during Upgrades</span></dt><dd><p>
      During a <code class="command">helm upgrade</code>, always ensure your
      <code class="filename">kubecf-config-values.yaml</code> file is passed. This will
      preserve any previously set Helm values while allowing additional
      Helm value changes to be made.
     </p></dd><dt id="id-1.3.5.3.4.3.3"><span class="term "><code class="command">helm rollback</code> Is Not Supported</span></dt><dd><p>
      <code class="command">helm rollback</code> is not supported in SUSE Cloud Application Platform or in
      upstream Cloud Foundry, and may break your cluster completely, because database
      migrations only run forward and cannot be reversed. Database schema can
      change over time. During upgrades both pods of the current and the next
      release may run concurrently, so the schema must stay compatible with the
      immediately previous release. But there is no way to guarantee such
      compatibility for future upgrades. One way to address this is to perform a
      full raw data backup and restore. (See
      <a class="xref" href="cha-cap-backup-restore.html#sec-cap-backup-restore-of-raw-data" title="21.2. Disaster Recovery through Raw Data Backup and Restore">Section 21.2, “Disaster Recovery through Raw Data Backup and Restore”</a>)
     </p></dd></dl></div></div><div class="sect1 " id="sec-cap-update"><div class="titlepage"><div><div><h2 class="title"><span class="number">13.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Upgrading SUSE Cloud Application Platform</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#sec-cap-update">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span>sec-cap-update</li></ul></div></div></div></div><p>
   The supported upgrade method is to install all upgrades, in order. Skipping
   releases is not supported. This table matches the Helm chart versions to
   each release:
  </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col /><col /><col /><col /><col /><col /><col /><col /><col /></colgroup><thead><tr><th>CAP Release</th><th>cf-operator Helm Chart Version</th><th>KubeCF Helm Chart Version</th><th>Stratos Helm Chart Version</th><th>Stratos Metrics Helm Chart Version</th><th>Minimum Kubernetes Version Required</th><th>CF API Implemented</th><th>Known Compatible CF CLI Version</th><th>CF CLI URL</th></tr></thead><tbody><tr><td>2.1.0 (current release)</td><td>6.1.17+0.gec409fd7</td><td>2.5.8</td><td>4.2.0</td><td>1.3.0</td><td>1.14</td><td>2.144.0</td><td>6.49.0</td><td><a class="link" href="https://github.com/cloudfoundry/cli/releases/tag/v6.49.0" target="_blank">https://github.com/cloudfoundry/cli/releases/tag/v6.49.0</a></td></tr><tr><td>2.0.1</td><td>4.5.13+.gd4738712</td><td>2.2.3</td><td>4.0.1</td><td>1.2.1</td><td>1.14</td><td>2.144.0</td><td>6.49.0</td><td><a class="link" href="https://github.com/cloudfoundry/cli/releases/tag/v6.49.0" target="_blank">https://github.com/cloudfoundry/cli/releases/tag/v6.49.0</a></td></tr><tr><td>2.0</td><td>4.5.6+0.gffc6f942</td><td>2.2.2</td><td>3.2.1</td><td>1.2.1</td><td>1.14</td><td>2.144.0</td><td>6.49.0</td><td><a class="link" href="https://github.com/cloudfoundry/cli/releases/tag/v6.49.0" target="_blank">https://github.com/cloudfoundry/cli/releases/tag/v6.49.0</a></td></tr></tbody></table></div><p>
   Use <code class="command">helm list</code> to see the version of your installed release
   . Perform sequential upgrades until you reach the desired SUSE Cloud Application Platform
   release.
  </p><p>
   The process to upgrade SUSE Cloud Application Platform will differ depending on the versions
   involved.
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     For upgrades from SUSE Cloud Application Platform 2.0.1 to SUSE Cloud Application Platform 2.1.0, see
     <a class="xref" href="cha-cap-upgrade.html#sec-cap-update-201-to-210" title="13.2.1. Upgrading from SUSE Cloud Application Platform 2.0.1 to SUSE Cloud Application Platform 2.1.0">Section 13.2.1, “Upgrading from SUSE Cloud Application Platform 2.0.1 to SUSE Cloud Application Platform 2.1.0”</a>.
    </p></li><li class="listitem "><p>                                                                       
     For upgrades from SUSE Cloud Application Platform 2.0 to SUSE Cloud Application Platform 2.0.1, see                 
     <a class="xref" href="cha-cap-upgrade.html#sec-cap-update-20-to-201" title="13.2.2. Upgrading from SUSE Cloud Application Platform 2.0 to SUSE Cloud Application Platform 2.0.1">Section 13.2.2, “Upgrading from SUSE Cloud Application Platform 2.0 to SUSE Cloud Application Platform 2.0.1”</a>.                                
    </p></li><li class="listitem "><p>
     For upgrades from SUSE Cloud Application Platform 1.5.2 to SUSE Cloud Application Platform 2.0, see
     <a class="xref" href="cha-cap-upgrade.html#sec-cap-update-152-to-20" title="13.2.3. Upgrading from SUSE Cloud Application Platform 1.5.2 to SUSE Cloud Application Platform 2.0">Section 13.2.3, “Upgrading from SUSE Cloud Application Platform 1.5.2 to SUSE Cloud Application Platform 2.0”</a>.
    </p></li></ul></div><div class="sect2 " id="sec-cap-update-201-to-210"><div class="titlepage"><div><div><h3 class="title"><span class="number">13.2.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Upgrading from SUSE Cloud Application Platform 2.0.1 to SUSE Cloud Application Platform 2.1.0</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#sec-cap-update-201-to-210">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span>sec-cap-update-201-to-210</li></ul></div></div></div></div><p>
    The following procedure will upgrade SUSE Cloud Application Platform 2.0.1 to SUSE Cloud Application Platform
    2.1.0
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Begin by upgrading cf-operator.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade <em class="replaceable ">cf-operator</em> suse/cf-operator \
 --namespace <em class="replaceable ">cf-operator</em> \
 --set "global.operator.watchNamespace=<em class="replaceable ">kubecf</em>" \
 --version 6.1.17+0.gec409fd7</pre></div></li><li class="step "><p>
     Wait until cf-operator is successfully upgraded before proceeding. Monitor
     the status of your cf-operator upgrade using the <code class="command">watch</code>
     command.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>watch --color 'kubectl get pods --namespace <em class="replaceable ">cf-operator</em>'</pre></div></li><li class="step "><p>
      When the cf-operator upgrade is completed, upgrade KubeCF. If you are
      planning to convert from Diego to Eirini, please upgrade your environment
      to CAP 2.1.0 first, then migrate to Eirini as the earlier CAP versions
      relied on a technical preview version of Eirini.
     </p><ol type="a" class="substeps "><li class="step "><p>
        Skip this step f you are not using an HA setup of the internal database
        in CAP 2.0.1. Otherwise you will need to scale down
        <code class="literal">sizing.database.instances</code> to 1 in order to upgrade to
        CAP 2.1.0. Running a high available version of the internal database
        during the upgrade will result in confusion during the password rotation
        process and you will run into difficulties recovering from it.
     </p></li><li class="step "><p>
      Perform the KubeCF upgrade. During the upgrade, applications will
      experience some downtime.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade <em class="replaceable ">kubecf</em> suse/kubecf \
 --namespace <em class="replaceable ">kubecf</em> \
 --values kubecf-config-values.yaml \
 --version 2.5.8</pre></div></li></ol></li><li class="step "><p>
      Monitor the status of your KubeCF upgrade using the <code class="command">watch</code>
      command.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>watch --color 'kubectl get pods --namespace <em class="replaceable ">kubecf</em>'</pre></div></li></ol></div></div></div><div class="sect2 " id="sec-cap-update-20-to-201"><div class="titlepage"><div><div><h3 class="title"><span class="number">13.2.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Upgrading from SUSE Cloud Application Platform 2.0 to SUSE Cloud Application Platform 2.0.1</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#sec-cap-update-20-to-201">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span>sec-cap-update-20-to-201</li></ul></div></div></div></div><p>
    The following procedure will upgrade SUSE Cloud Application Platform 2.0 to SUSE Cloud Application Platform
    2.0.1.
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Begin by upgrading cf-operator.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade <em class="replaceable ">cf-operator</em> suse/cf-operator \
 --namespace <em class="replaceable ">cf-operator</em> \
 --set "global.operator.watchNamespace=<em class="replaceable ">kubecf</em>" \
 --version 4.5.13+.gd4738712</pre></div></li><li class="step "><p>
     Wait until cf-operator is successfully upgraded before proceeding. Monitor
     the status of your cf-operator upgrade using the <code class="command">watch</code>
     command.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>watch --color 'kubectl get pods --namespace <em class="replaceable ">cf-operator</em>'</pre></div></li><li class="step "><p>
      When the cf-operator upgrade is completed, upgrade KubeCF.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade <em class="replaceable ">kubecf</em> suse/kubecf \
 --namespace <em class="replaceable ">kubecf</em> \
 --values kubecf-config-values.yaml \
 --version 2.2.3</pre></div></li><li class="step "><p>
      Monitor the status of your KubeCF upgrade using the <code class="command">watch</code>
      command.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>watch --color 'kubectl get pods --namespace <em class="replaceable ">kubecf</em>'</pre></div></li></ol></div></div></div><div class="sect2 " id="sec-cap-update-152-to-20"><div class="titlepage"><div><div><h3 class="title"><span class="number">13.2.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Upgrading from SUSE Cloud Application Platform 1.5.2 to SUSE Cloud Application Platform 2.0</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#sec-cap-update-152-to-20">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span>sec-cap-update-152-to-20</li></ul></div></div></div></div><p>
    The transition from SUSE Cloud Application Platform 1.5.2 to SUSE Cloud Application Platform 2.0 involves a
    migration of data rather than a direct upgrade. This process is outlined in
    the subsections below.
   </p><div id="id-1.3.5.3.5.9.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Scope of Migration</h6><p>
     This procedure only imports the UAA and CC databases. It does not import the
     Credhub and Diego BBS databases. Service credentials from Credhub are
     missing, and Diego does not know anything about the desired app states
     All running apps need to be restarted so that Diego knows about them.
    </p><p>
     This whole procedure also does not deal with exporting and recreating
     services.
    </p></div><div class="sect3 " id="sec-cap-upgrade-export-scf"><div class="titlepage"><div><div><h4 class="title"><span class="number">13.2.3.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Export Data from Existing SCF Deployment</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#sec-cap-upgrade-export-scf">#</a></h4><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span>sec-cap-upgrade-export-scf</li></ul></div></div></div></div><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
       Export the blobstore.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --namespace scf blobstore-0 -- tar cfz -
 --exclude=/var/vcap/store/shared/tmp /var/vcap/store/shared &gt; blob.tgz</pre></div></li><li class="step "><p>
       Export the User Account and Authentication database (UAADB).
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec mysql-0 --namespace uaa -- bash -c
 '/var/vcap/packages/mariadb/bin/mysqldump \
    --defaults-file=/var/vcap/jobs/mysql/config/mylogin.cnf \
    --socket /var/vcap/sys/run/pxc-mysql/mysqld.sock \
    uaadb' &gt; uaadb-src.sql</pre></div></li><li class="step "><p>
       Export the Cloud Controller database (CCDB).
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec mysql-0 --namespace scf -- bash -c
 '/var/vcap/packages/mariadb/bin/mysqldump \
    --defaults-file=/var/vcap/jobs/mysql/config/mylogin.cnf \
    --socket /var/vcap/sys/run/pxc-mysql/mysqld.sock \
    ccdb' &gt; ccdb-src.sql</pre></div></li><li class="step "><p>
       Save database encryption key.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin --tty --namespace scf api-group-0 --
 bash -c "cat /var/vcap/jobs/cloud_controller_ng/config/cloud_controller_ng.yml |
 grep -A 10 db_encryption" &gt; enc_key</pre></div></li><li class="step "><p>
       Lock all buildpacks.
      </p><p>
       When the Cloud Controller (CC) starts, it will replace all unlocked admin
       buildpacks with the versions bundled with the release. So if the
       buildpacks from the 1.5.2 export are required to restage applications,
       then they need to be locked before the CCDB is exported.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>for BP in $(cf buildpacks | perl -ne 'print if
 s/(_buildpack).*/\1/' | uniq); do cf update-buildpack $BP -s sle15 --lock; done

 <code class="prompt user">tux &gt; </code>for BP in $(cf buildpacks | perl -ne 'print if
 s/(_buildpack).*/\1/' | uniq); do cf update-buildpack $BP -s cflinuxfs3 --lock;
 done</pre></div></li><li class="step "><p>
       Rotate secrets and database encryption key. Do not copy the example as is,
 ensure a secure key is used in place of the example value of
 <em class="replaceable ">abcdef</em>.
      </p><ol type="a" class="substeps "><li class="step "><p>
         If the deployment uses an embedded UAA or an external UAA with a
         certificate signed by a well known Certificate Authority (CA), skip this
         step.
        </p><p>
         For deployments using an external UAA with either a certificate
         generated by the secret-generator or a self-signed certificate, the
         UAA's CA cert (<code class="literal">UAA_CA_CERT</code>) must be set in the
         <code class="command">helm upgrade</code> command.
        </p><p>
         Obtain your UAA secret and certificate: 
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>SECRET=$(kubectl get pods --namespace uaa \
 --output
 jsonpath='{.items[?(.metadata.name=="uaa-0")].spec.containers[?(.name=="uaa")].env[?(.name=="INTERNAL_CA_CERT")].valueFrom.secretKeyRef.name}')

 <code class="prompt user">tux &gt; </code>CA_CERT="$(kubectl get secret $SECRET --namespace uaa \
 --output jsonpath="{.data['internal-ca-cert']}" | base64 --decode -)"</pre></div><p>
         Then include <code class="command">--set "secrets.UAA_CA_CERT=${CA_CERT}"</code>
         as part of the <code class="command">helm upgrade</code> command in the next step. 
        </p></li><li class="step "><p>
         Use <code class="command">helm upgrade</code> to apply the configuration update
         and rotate all generated secrets.
        </p><p>
         If secrets have been rotated previously 
         <code class="literal">kube.secrets_generation_counter</code> has
         already been set), be sure the new value provided for
         <code class="literal">kube.secrets_generation_counter</code> is an increment of
         the existing one.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade susecf-scf suse/cf \
 --namespace <em class="replaceable ">scf</em> \
 --set env.CC_DB_CURRENT_KEY_LABEL=<em class="replaceable ">NEW_KEY</em> \
 --set
 secrets.CC_DB_ENCRYPTION_KEYS.<em class="replaceable ">NEW_KEY</em>=<em class="replaceable ">abcdef</em>
 \
 --set kube.secrets_generation_counter=<em class="replaceable ">2</em> \
 --values scf-config-values.yaml \
 --version 2.20.3</pre></div><p>
         Wait until all pods are ready. To monitor the progress run the following
         command.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>watch --color 'kubectl get pods --namespace
 scf'</pre></div></li><li class="step "><p>
         With the new encryption key in place, perform the rotation.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --namespace scf api-group-0 -- bash -c 'source
 /var/vcap/jobs/cloud_controller_ng/bin/ruby_version.sh; export
 CLOUD_CONTROLLER_NG_CONFIG=/var/vcap/jobs/cloud_controller_ng/config/cloud_controller_ng.yml;
 cd /var/vcap/packages/cloud_controller_ng/cloud_controller_ng; bundle exec rake
 rotate_cc_database_key:perform'</pre></div></li><li class="step "><p>
         Restart the pods for the changes to take effect.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl delete pod api-group-0 --namespace scf
 <code class="prompt user">tux &gt; </code>kubectl delete pod cc-worker-0 --namespace scf
 <code class="prompt user">tux &gt; </code>kubectl delete pod cc-clock-0 --namespace scf</pre></div></li></ol></li><li class="step "><p>
       Save the CCDB with locked buildpacks and rotated secrets/encryption keys.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec mysql-0 --namespace scf -- bash -c
 '/var/vcap/packages/mariadb/bin/mysqldump \
   --defaults-file=/var/vcap/jobs/mysql/config/mylogin.cnf \
   --socket /var/vcap/sys/run/pxc-mysql/mysqld.sock \
   ccdb' &gt; ccdb-rotated-src.sql

 <code class="prompt user">tux &gt; </code>kubectl exec --stdin --tty --namespace scf api-group-0 -- bash -c
 "cat /var/vcap/jobs/cloud_controller_ng/config/cloud_controller_ng.yml | grep -A
 10 db_encryption" &gt; enc_key_rotated</pre></div></li><li class="step "><p>
       Verify you have collected all required files.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ls -l
 -rw-r--r-- 1 501 20 217539560 May 27 18:23 blob.tgz
 -rw-r--r-- 1 501 20    231904 May 27 19:53 ccdb-rotated-src.sql
 -rw-r--r-- 1 501 20    225726 May 27 18:24 ccdb-src.sql
 -rw-r--r-- 1 501 20       220 May 27 18:29 enc_key
 -rw-r--r-- 1 501 20       245 May 27 19:51 enc_key_rotated
 -rw-r--r-- 1 501 20     66281 May 27 18:24 uaadb-src.sql</pre></div></li></ol></div></div></div><div class="sect3 " id="sec-cap-upgrade-import-kube"><div class="titlepage"><div><div><h4 class="title"><span class="number">13.2.3.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Import Data into New KubeCF Deployment</span> <a title="Permalink" class="permalink" href="cha-cap-upgrade.html#sec-cap-upgrade-import-kube">#</a></h4><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_upgrade.xml</li><li><span class="ds-label">ID: </span>sec-cap-upgrade-import-kube</li></ul></div></div></div></div><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
       Deploy a SUSE Cloud Application Platform 2.0 cluster. Refer to the instructions for your
       target platform. Use <code class="literal">4.5.6+0.gffc6f942</code> as the
       cf-operator version and <code class="literal">2.2.2</code> as the KubeCF version.
      </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
    For SUSE® CaaS Platform, see <a class="xref" href="cha-cap-depl-caasp.html" title="Chapter 4. Deploying SUSE Cloud Application Platform on SUSE CaaS Platform">Chapter 4, <em>Deploying SUSE Cloud Application Platform on SUSE CaaS Platform</em></a>.
   </p></li><li class="listitem "><p>
    For Microsoft Azure Kubernetes Service, see <a class="xref" href="cha-cap-depl-aks.html" title="Chapter 5. Deploying SUSE Cloud Application Platform on Microsoft Azure Kubernetes Service (AKS)">Chapter 5, <em>Deploying SUSE Cloud Application Platform on Microsoft Azure Kubernetes Service (AKS)</em></a>.
   </p></li><li class="listitem "><p>
    For Amazon Elastic Kubernetes Service, see <a class="xref" href="cha-cap-depl-eks.html" title="Chapter 6. Deploying SUSE Cloud Application Platform on Amazon Elastic Kubernetes Service (EKS)">Chapter 6, <em>Deploying SUSE Cloud Application Platform on Amazon Elastic Kubernetes Service (EKS)</em></a>.
   </p></li><li class="listitem "><p>
    For Google Kubernetes Engine, see <a class="xref" href="cha-cap-depl-gke.html" title="Chapter 7. Deploying SUSE Cloud Application Platform on Google Kubernetes Engine (GKE)">Chapter 7, <em>Deploying SUSE Cloud Application Platform on Google Kubernetes Engine (GKE)</em></a>.
   </p></li></ul></div></li><li class="step "><p>
       Import the UAA database.
      </p><p>
       The current database configuration does not allow importing of a mysqldump
       , so needs to be made more permissive
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cat &lt;&lt;EOF | kubectl exec -i database-0 --namespace
 kubecf -- mysql
 SET GLOBAL pxc_strict_mode=PERMISSIVE;
 SET GLOBAL
 sql_mode='STRICT_ALL_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
 set GLOBAL innodb_strict_mode='OFF';
 EOF</pre></div><p>
       It is not possible to drop the KubeCF database for UAA and import the
       version from SCF. KubeCF has additional clients and scopes that would
       get lost. So the migration strategy is to only extract users and
       passwords from the export, and add them to KubeCF. Since this is a new
       setup, none of the users should exist. Except for <code class="literal">admin</code>
       , so we are only updating the password for that user.
     </p><p>
       The <code class="filename">adduser.pl</code> script will also update all identity
       zone ids to <code class="literal">uaa</code>, in case the export comes from an
       external and not an embedded UAA.
      </p><div class="verbatim-wrap"><pre class="screen"># adduser.pl
 use strict;
 use warnings;

 my %table;
 while (&lt;&gt;) {
     my($insert,$table,$values) = /^(INSERT INTO `(.*?)` VALUES) (.*);$/ or next;

     my $literal_value = qr/ ' (?: [^'\\] | '' | \\. )* ' | -?\w+ /x;
     # Each row contains the comma-separated list of values including the
     # surrounding parens.
     my @rows = $values =~ / \( (?: (?: $literal_value ) ,? )+ \) /gx;

     my @records;
     # Each record is a reference to a list of all fields of a row.
     foreach my $record (map [/$literal_value/g], @rows) {
         # Replace old identity_zone_id with 'uaa'.
         my %zone_id_column = (group_membership =&gt; 7, groups =&gt; 5,
 oauth_client_details =&gt; 11,
                               user_google_mfa_credentials =&gt; 5, users =&gt; 15);
         $record-&gt;[$zone_id_column{$table}] = "'uaa'" if defined
 $zone_id_column{$table};

         # Admin user name has changed from uaaadmin to uaa.
         $record-&gt;[6] = 'uaa' if $table eq "schema_version";

         push @records, $record;
     }
     $table{$table} = \@records;
 }

 my $users = $table{users};
 my $admin = (grep $_-&gt;[4] eq "'admin'", @$users)[0];
 die unless $admin;
 my $admin_id = $admin-&gt;[0];

 # Set admin password to exported value.
 printf "UPDATE `users` SET password = %s WHERE username = 'admin';\n",
 $admin-&gt;[5];

 # Export all tables that have a user_id column.
 my %id_column = (user_google_mfa_credentials =&gt; 0, user_info =&gt; 0, users =&gt; 0);
 for my $table (keys %id_column) {
     # Add records for all users, except 'admin'.
     for my $record (grep $_-&gt;[$id_column{$table}] ne $admin_id,
 @{$table{$table}}) {
         printf "INSERT INTO `$table` VALUES(%s);\n", join(",", @$record);
     }
 }</pre></div><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>perl adduser.pl uaadb-src.sql &gt; adduser.sql
 cat adduser.sql

 kubectl exec -i database-0 --namespace kubecf -- mysql uaa &lt; adduser.sql

 echo "select username from uaa.users;" | kubectl exec -i database-0 --namespace
 kubecf -- mysql
 cf login --skip-ssl-validation -a https://api.&lt;system_domain&gt; -u admin -p
 changeme</pre></div></li><li class="step "><p>
       Import the blobstore.
      </p><p>
       The blobstore is still empty, except for the admin buildpacks. The
       buildpacks will be reinstalled anyways, unless the CCDB in the export has
       them locked, so deleting them here is kind of optional.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --namespace kubecf singleton-blobstore-0 -- rm
 -rf /var/vcap/store/shared/cc-buildpacks
 <code class="prompt user">tux &gt; </code>kubectl exec -i --namespace kubecf singleton-blobstore-0 -- tar xfz
 - -C / &lt; blob.tgz
 <code class="prompt user">tux &gt; </code>kubectl delete pod --namespace kubecf singleton-blobstore-0</pre></div></li><li class="step "><p>
       Import the Cloud Controller database (CCDB).
      </p><p>
       The CC database includes routes, that <span class="emphasis"><em>may</em></span> need to be
 updated for the new
       cluster. The list of migrations also includes artificial
       "squashed migrations" that are generated by SCF to combine all previous
       migrations into a single transaction. These squashed migrations don't
       exist in KubeCF and must be filtered out. The original migrations still
       exist in the table, so no other actions are required.
      </p><div class="verbatim-wrap"><pre class="screen"># normalize.pl
 use strict;
 use warnings;

 while (&lt;&gt;) {
     if (my($insert,$table,$values) = /^(INSERT INTO `(.*?)` VALUES) (.*);$/) {
         my $literal_value = qr/ ' (?: [^'\\] | '' | \\. )* ' | -?\w+ /x;
         # Each row contains the comma-separated list of values including the
         # surrounding parens.
         my @rows = $values =~ / \( (?: (?: $literal_value ) ,? )+ \) /gx;

         my @records;
         # Each record is a reference to a list of all fields of a row.
         foreach my $record (map [/$literal_value/g], @rows) {
             # Squashed migration are an SCF optimization that doesn't exist in
             # kubecf.
             next if $table eq "schema_migrations" &amp;&amp; $record-&gt;[0] =~
 /^'\d+_squashed_migrations.rb'$/;
             push @records, $record;
         }

         # Print each row on a separate line for easier reading/comparison.
         printf "$insert\n%s;\n", join(",\n", map(sprintf("  (%s)", join(",",
 @$_)), @records));
         next;
     }

     print;
 }</pre></div><p>
       For a CCDB that has not been rotated:
      </p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>
         Update the routes for the new cluster in the
         <code class="filename">ccdb-src.sql</code> file. Replace the placeholders values
         with the value of <code class="literal">DOMAIN</code> from the SCF cluster and the
         value of <code class="literal">system_domain</code> from the KubeCF cluster.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>sed
 "s/<em class="replaceable ">SCF_DOMAIN</em>/<em class="replaceable ">KubeCF_system_domain</em>/g"
 ccdb-src.sql &gt; ccdb-src-kubecf.sql</pre></div></li><li class="listitem "><p>
         Filter out the squashed migrations.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>perl normalize.pl ccdb-src-kubecf.sql &gt; normal.sql</pre></div></li><li class="listitem "><p>
         Drop the current CCDB and import the dump from SCF.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>echo "drop database cloud_controller; create database
 cloud_controller;" | \
      kubectl exec -i database-0 --namespace kubecf -- mysql
 <code class="prompt user">tux &gt; </code>kubectl exec -i database-0 --namespace kubecf -- mysql
 cloud_controller &lt; normal.sql</pre></div></li></ol></div><p>
       For a CCDB that has already been rotated before:
      </p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>
         Update the routes for the new cluster in the
         <code class="filename">ccdb-rotated-src.sql</code> file. Replace the placeholders
 values
         with the value of <code class="literal">DOMAIN</code> from the SCF cluster and the
         value of <code class="literal">system_domain</code> from the KubeCF cluster.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>sed
 "s/<em class="replaceable ">SCF_DOMAIN</em>/<em class="replaceable ">KubeCF_system_domain</em>/g"
 ccdb-rotated-src.sql &gt; ccdb-src-kubecf.sql</pre></div></li><li class="listitem "><p>
         Filter out the squashed migrations.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>perl normalize.pl ccdb-src-kubecf.sql &gt; normal.sql</pre></div></li><li class="listitem "><p>
         Drop the current CCDB and import the dump from SCF.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>echo "drop database cloud_controller; create database
 cloud_controller;" | \
      kubectl exec -i database-0 --namespace kubecf -- mysql
 <code class="prompt user">tux &gt; </code>kubectl exec -i database-0 --namespace kubecf -- mysql
 cloud_controller &lt; normal.sql</pre></div></li></ol></div></li><li class="step "><p>
       Update the encryption key.
      </p><p>
       For a CCDB that has not been rotated:
      </p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cat enc_key
 db_encryption_key:
 qmF4BZxVUZoVkvDdYi2crkezdNWww6mLRh32W77VsLY5xhinpunVNp1d2mzc3O7F

 database_encryption:
   keys: {}
   current_key_label: ""
   pbkdf2_hmac_iterations: 2048</pre></div></li><li class="listitem "><p>
         When only <code class="literal">db_encryption_key</code> is set, we must use the
         same legacy mechanism in KubeCF as well.
        </p><p>
         Create a YAML configuration file with the structure below. Replace the
         example values with the values found in the
         <code class="filename">enc_key</code> file.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cat enc_key_values.yaml
 credentials:
   cc_db_encryption_key:
 <em class="replaceable ">qmF4BZxVUZoVkvDdYi2crkezdNWww6mLRh32W77VsLY5xhinpunVNp1d2mzc3O7F</em></pre></div><p>
          Use <code class="command">helm upgrade</code> to apply the configuration update.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade kubecf suse/kubecf \
 --namespace <em class="replaceable ">kubecf</em> \
 --values kubecf-config-values.yaml \
 --values enc_key_values.yaml \
 --version 2.5.8</pre></div></li></ol></div><p>
       For a CCDB that has already been rotated before:
      </p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cat enc_key_rotated
 db_encryption_key:
 qmF4BZxVUZoVkvDdYi2crkezdNWww6mLRh32W77VsLY5xhinpunVNp1d2mzc3O7F

 database_encryption:
   keys: {"NEW_KEY":"abcdef"}
   current_key_label: "NEW_KEY"
   pbkdf2_hmac_iterations: 2048</pre></div></li><li class="listitem "><p>
         Since a rotated key exists, <code class="literal">db_encryption_key</code> can be
         ignored. The <code class="literal">current_key_label</code> setting must be copied
         over, with the exact same name and value. Any other (older) keys in that
         set can be ignored, as long as encryption key rotation has been
         performed in SCF since the last update to that list.
        </p><p>
         Create a YAML configuration file with the structure below. Replace the
         example values with the values found in the
        <code class="filename">enc_key_rotated</code> file.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cat enc_key_values.yaml
 ccdb:
   encryption:
     rotation:
       key_labels:
       - NEW_KEY
       current_key_label: NEW_KEY

 credentials:
   cc_db_encryption_key:
 qmF4BZxVUZoVkvDdYi2crkezdNWww6mLRh32W77VsLY5xhinpunVNp1d2mzc3O7F
   ccdb_key_label_new_key: abcdef</pre></div><p>
          Use <code class="command">helm upgrade</code> to apply the configuration update.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade kubecf suse/kubecf \
 --namespace <em class="replaceable ">kubecf</em> \
 --values kubecf-config-values.yaml \
 --values enc_key_values.yaml \
 --version 2.5.8</pre></div></li></ol></div><p>
       Wait until <code class="literal">api</code>, <code class="literal">cc-worker</code>, and
       <code class="literal">scheduler</code> have restarted. To monitor the progress run
       the following command.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>watch --color 'kubectl get pods --namespace
 kubecf'</pre></div></li><li class="step "><p>
       Rotate the encryption key.
      </p><p>
       The imported data can now be decrypted with the legacy
       <code class="literal">db_encryption_key</code>. For consistency we want to run a
       rotation, so all the imported data will be re-encrypted with the current
       KubeCF encryption key.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl patch qjob rotate-cc-database-key --namespace
 kubecf --type merge \
       --patch '{"spec":{"trigger":{"strategy":"now"}}}'

 <code class="prompt user">tux &gt; </code>kubectl logs -l
 quarks.cloudfoundry.org/qjob-name=rotate-cc-database-key --namespace kubecf -c
 logs -f</pre></div></li><li class="step "><p>
       Verify everything works.
      </p><ol type="a" class="substeps "><li class="step "><p>
         Target an existing <code class="literal">org</code> and <code class="literal">space</code>
         from your previous SUSE Cloud Application Platform 1.5.2 deployment.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf target -o EXISTING_ORG -s EXISTING_SPACE</pre></div></li><li class="step "><p>
         Verify the apps that were previously deployed to the
         <code class="literal">org</code> and <code class="literal">space</code> are listed.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf apps
 name        requested state   instances   memory   disk   urls
 12factor    started           0/1         64M      256M   12factor.example.com</pre></div></li><li class="step "><p>
         The <code class="literal">started</code> value for
         <code class="literal">requested state</code> is misleading. Since we did not
         import the BBS database, Diego does not know anything about these apps.
         No app instances will be started until the <code class="command">cf restart</code>
         command is manually issued (it does not require restaging).
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf restart 12factor</pre></div><p>
         Repeat for all apps.
        </p></li><li class="step "><p>
         Check the encryption key.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin --tty --namespace kubecf api-0 -- bash
 -c "cat /var/vcap/jobs/cloud_controller_ng/config/cloud_controller_ng.yml | grep
 -A 10 db_encryption"
 Defaulting container name to cloud-controller-ng-cloud-controller-ng.
 Use 'kubectl describe pod/api-0 -n kubecf' to see all of the containers in this
 pod.
 db_encryption_key:
 qmF4BZxVUZoVkvDdYi2crkezdNWww6mLRh32W77VsLY5xhinpunVNp1d2mzc3O7F

 database_encryption:
   keys:
 {"ccdb_key_label_encryption_key_0":"jHlbjl11nZ2wqdh9bCA9ZIOCMxgseIf7OyVP2aSrESmZEuovqLXSWPTKTEcU0CCo"}
   current_key_label: "ccdb_key_label_encryption_key_0"
   pbkdf2_hmac_iterations: 2048</pre></div></li><li class="step "><p>
         List the buildpacks.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf buildpacks
 Getting buildpacks...

 buildpack               position   enabled   locked   filename
 stack
 staticfile_buildpack    1          true      false
 staticfile-buildpack-sle15-v1.5.5.1-5.1-eaf36a02.zip    sle15
 staticfile_buildpack    2          true      false
 staticfile_buildpack-cflinuxfs3-v1.5.4.zip              cflinuxfs3
 ...</pre></div><p>
         These are the buildpacks bundled with KubeCF. Since buildpacks in the
         CCDB were not locked, they were upgraded when the <code class="literal">api</code>
         (or <code class="literal">cc-worker</code>) pods were restarted.
        </p></li></ol></li><li class="step "><p>
       To update previously locked buildpacks to the KubeCF version, unlock the
       buildpack and restart the Cloud Controller.
      </p><ol type="a" class="substeps "><li class="step "><p>
         This example unlocks all buildpacks associated with the
         <code class="literal">cflinuxfs3</code> stack.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>for BP in $(cf buildpacks | perl -ne 'print if
 s/(_buildpack).*/\1/' | uniq); do cf update-buildpack $BP -s cflinuxfs3
 --unlock; done
 Updating buildpack staticfile_buildpack with stack cflinuxfs3 as admin...
 OK</pre></div></li><li class="step "><p>
         Restart the <code class="literal">api</code> pod. Restarting the
         <code class="literal">api</code> pod will cause a restart of the CC. As the CC
         starts, all <span class="emphasis"><em>unlocked</em></span> admin buildpacks will be
         replaced with versions bundled in the release.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl delete pod api-0 --namespace kubecf
 pod "api-0" deleted</pre></div><p>
         After restarting the <code class="literal">api-0i</code> pod, wait for it to be
         ready again. To monitor the progress run the following command.
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>watch --color 'kubectl get pods --namespace
 kubecf'</pre></div></li><li class="step "><p>
         Verify the buildpacks have been updated to the KubeCF version.  
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf buildpacks</pre></div></li></ol></li></ol></div></div></div></div></div></div></div><div class="page-bottom"><div id="_bottom-navigation"><a class="nav-link" href="cha-cap-configuration-changes.html"><span class="next-icon">→</span><span class="nav-label"><span class="number">Chapter 14 </span>Configuration Changes</span></a><a class="nav-link" href="part-cap-administration.html"><span class="prev-icon">←</span><span class="nav-label"><span class="number">Part III </span>SUSE Cloud Application Platform Administration</span></a></div><div class="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span class="_share-fb bottom-button">Facebook</span><span class="spacer"> • </span><span class="_share-in bottom-button">LinkedIn</span><span class="spacer"> • </span><span class="_share-tw bottom-button">Twitter</span><span class="spacer"> • </span><span class="_share-mail bottom-button">E-Mail</span></span></div><div class="print"><span class="_print-button bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2021 
        SUSE</p><ul><li><a href="https://jobs.suse.com/" target="_top">Careers</a></li><li><a href="https://www.suse.com/company/legal/" target="_top">Legal</a></li><li><a href="https://www.suse.com/company/about/" target="_top">About</a></li><li><a href="https://www.suse.com/contact/" target="_top">Contact Us</a></li></ul></div></div></body></html>
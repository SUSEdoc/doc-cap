<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Cloud Controller Database Secret Rotation | Deployment, Administration, and User Guides | SUSE Cloud Application Platform 2.1.0</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" /><meta name="generator" content="DAPS 3.0.0 (https://opensuse.github.io/daps) using SUSE XSL Stylesheets 2.0.17 (based on DocBook XSL Stylesheets 1.79.2) - chunked" /><meta name="product-name" content="SUSE Cloud Application Platform" /><meta name="product-number" content="2.1.0" /><meta name="book-title" content="Deployment, Administration, and User Guides" /><meta name="chapter-title" content="Chapter 19. Cloud Controller Database Secret Rotation" /><meta name="description" content="The Cloud Controller Database (CCDB) encrypts sensitive information like passwords. The encryption key is generated when KubeCF is deployed. If it is compromised or needs to be rotated for any other reason, new keys can be added. Note that existing encrypted information will not be updated. The encr…" /><meta name="tracker-url" content="https://github.com/SUSE/doc-cap/issues/new" /><meta name="tracker-type" content="gh" /><meta name="tracker-gh-assignee" content="btat" /><meta name="tracker-gh-labels" content="bug,low priority" /><link rel="home" href="index.html" title="SUSE Cloud Application Platform 2.1.0 Documentation" /><link rel="up" href="part-cap-administration.html" title="Part III. SUSE Cloud Application Platform Administration" /><link rel="prev" href="cha-cap-memory-limits.html" title="Chapter 18. Container Memory Limits and Requests" /><link rel="next" href="cha-cap-secrets-rotation.html" title="Chapter 20. Rotating Automatically Generated Secrets" />
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css"></link>');
}
else {
  document.write('<link rel="stylesheet" type="text/css" href="static/css/fonts-onlylocal.css"></link>');
}

</script><noscript><link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css" /></noscript><script src="static/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-navigation">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><div id="_outer-wrap"><div id="_white-bg" style="background-color: #FABEBE;"><div id="_header"><div id="_logo"><img src="static/images/logo.png" alt="Logo" /></div><div class="crumbs"><a class="book-link" href="index.html" title="SUSE Cloud Application Platform 2.1.0 Documentation"><span class="book-icon">SUSE Cloud Application Platform 2.1.0 Documentation</span></a><span> › </span><a class="crumb" href="book-cap-guides.html">Deployment, Administration, and User Guides</a><span> › </span><a class="crumb" href="part-cap-administration.html">SUSE Cloud Application Platform Administration</a><span> › </span><a class="crumb" href="cha-cap-ccdb-secret-rotation.html">Cloud Controller Database Secret Rotation</a></div><div class="clearme"></div></div></div><div id="_toolbar-wrap"><div id="_toolbar"><div id="_toc-area" class="inactive"><a id="_toc-area-button" class="tool" title="Contents" accesskey="c" href="index.html"><span class="tool-spacer"><span class="toc-icon">Contents</span><span class="clearme"></span></span><span class="tool-label">Contents</span></a><div class="active-contents bubble-corner"></div><div class="active-contents bubble"><div class="bubble-container"><h6>Deployment, Administration, and User Guides</h6><div id="_bubble-toc"><ol><li class="inactive"><a href="preface-deployment.html"><span class="number"> </span><span class="name">About This Guide</span></a></li><li class="inactive"><a href="part-cap-overview.html"><span class="number">I </span><span class="name">Overview of SUSE Cloud Application Platform</span></a><ol><li class="inactive"><a href="cha-cap-overview.html"><span class="number">1 </span><span class="name">About SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-depl-kube-requirements.html"><span class="number">2 </span><span class="name">Other Kubernetes Systems</span></a></li></ol></li><li class="inactive"><a href="part-cap-deployment.html"><span class="number">II </span><span class="name">Deploying SUSE Cloud Application Platform</span></a><ol><li class="inactive"><a href="cha-cap-depl-notes.html"><span class="number">3 </span><span class="name">Deployment and Administration Notes</span></a></li><li class="inactive"><a href="cha-cap-depl-caasp.html"><span class="number">4 </span><span class="name">Deploying SUSE Cloud Application Platform on SUSE CaaS Platform</span></a></li><li class="inactive"><a href="cha-cap-depl-aks.html"><span class="number">5 </span><span class="name">Deploying SUSE Cloud Application Platform on Microsoft Azure Kubernetes Service (AKS)</span></a></li><li class="inactive"><a href="cha-cap-depl-eks.html"><span class="number">6 </span><span class="name">Deploying SUSE Cloud Application Platform on Amazon Elastic Kubernetes Service (EKS)</span></a></li><li class="inactive"><a href="cha-cap-depl-gke.html"><span class="number">7 </span><span class="name">Deploying SUSE Cloud Application Platform on Google Kubernetes Engine (GKE)</span></a></li><li class="inactive"><a href="cha-cap-install-stratos.html"><span class="number">8 </span><span class="name">Installing the Stratos Web Console</span></a></li><li class="inactive"><a href="cha-cap-depl-eirini.html"><span class="number">9 </span><span class="name">Eirini</span></a></li><li class="inactive"><a href="cha-cap-depl-terraform.html"><span class="number">10 </span><span class="name">Deploying SUSE Cloud Application Platform Using Terraform</span></a></li><li class="inactive"><a href="cha-cap-depl-air-gap-registry.html"><span class="number">11 </span><span class="name">Setting Up a Registry for an Air Gapped Environment</span></a></li><li class="inactive"><a href="cha-cap-depl-private-registry.html"><span class="number">12 </span><span class="name">SUSE Private Registry</span></a></li></ol></li><li class="inactive"><a href="part-cap-administration.html"><span class="number">III </span><span class="name">SUSE Cloud Application Platform Administration</span></a><ol><li class="inactive"><a href="cha-cap-upgrade.html"><span class="number">13 </span><span class="name">Upgrading SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-configuration-changes.html"><span class="number">14 </span><span class="name">Configuration Changes</span></a></li><li class="inactive"><a href="cha-cap-create-admin-user.html"><span class="number">15 </span><span class="name">Creating Admin Users</span></a></li><li class="inactive"><a href="cha-cap-manage-passwords.html"><span class="number">16 </span><span class="name">Managing Passwords</span></a></li><li class="inactive"><a href="cha-cap-uaa-ui.html"><span class="number">17 </span><span class="name">Accessing the UAA User Interface</span></a></li><li class="inactive"><a href="cha-cap-memory-limits.html"><span class="number">18 </span><span class="name">Container Memory Limits and Requests</span></a></li><li class="inactive"><a href="cha-cap-ccdb-secret-rotation.html"><span class="number">19 </span><span class="name">Cloud Controller Database Secret Rotation</span></a></li><li class="inactive"><a href="cha-cap-secrets-rotation.html"><span class="number">20 </span><span class="name">Rotating Automatically Generated Secrets</span></a></li><li class="inactive"><a href="cha-cap-backup-restore.html"><span class="number">21 </span><span class="name">Backup and Restore</span></a></li><li class="inactive"><a href="cha-cap-service-brokers.html"><span class="number">22 </span><span class="name">Service Brokers</span></a></li><li class="inactive"><a href="cha-cap-app-autoscaler.html"><span class="number">23 </span><span class="name">App-AutoScaler</span></a></li><li class="inactive"><a href="cha-cap-credhub.html"><span class="number">24 </span><span class="name">Integrating CredHub with SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-buildpacks.html"><span class="number">25 </span><span class="name">Buildpacks</span></a></li></ol></li><li class="inactive"><a href="part-cap-user-guide.html"><span class="number">IV </span><span class="name">SUSE Cloud Application Platform User Guide</span></a><ol><li class="inactive"><a href="cha-cap-cf-cli.html"><span class="number">26 </span><span class="name">Deploying and Managing Applications with the Cloud Foundry Client</span></a></li></ol></li><li class="inactive"><a href="part-cap-troubleshooting.html"><span class="number">V </span><span class="name">Troubleshooting</span></a><ol><li class="inactive"><a href="cha-cap-depl-troubleshooting.html"><span class="number">27 </span><span class="name">Troubleshooting</span></a></li></ol></li><li class="inactive"><a href="bk01apa.html"><span class="number">A </span><span class="name">Appendix</span></a></li><li class="inactive"><a href="bk01apb.html"><span class="number">B </span><span class="name">GNU Licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_nav-area" class="inactive"><div class="tool"><span class="nav-inner"><span class="tool-label">Navigation</span><a accesskey="p" class="tool-spacer" title="Chapter 18. Container Memory Limits and Requests" href="cha-cap-memory-limits.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 20. Rotating Automatically Generated Secrets" href="cha-cap-secrets-rotation.html"><span class="next-icon">→</span></a></span></div></div></div></div><div id="_fixed-header-wrap" style="background-color: #FABEBE;" class="inactive"><div id="_fixed-header"><div class="crumbs"><a class="book-link" href="index.html" title="SUSE Cloud Application Platform 2.1.0 Documentation"><span class="book-icon">SUSE Cloud Application Platform 2.1.0 Documentation</span></a><span> › </span><a class="crumb" href="book-cap-guides.html">Deployment, Administration, and User Guides</a><span> › </span><a class="crumb" href="part-cap-administration.html">SUSE Cloud Application Platform Administration</a><span> › </span><a class="crumb" href="cha-cap-ccdb-secret-rotation.html">Cloud Controller Database Secret Rotation</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="button"><a accesskey="p" class="tool-spacer" title="Chapter 18. Container Memory Limits and Requests" href="cha-cap-memory-limits.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 20. Rotating Automatically Generated Secrets" href="cha-cap-secrets-rotation.html"><span class="next-icon">→</span></a></div><div class="clearme"></div></div><div class="clearme"></div></div></div><div id="_content" class="draft "><div class="documentation"><div class="chapter " id="cha-cap-ccdb-secret-rotation"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname ">SUSE Cloud Application Platform</span> <span class="productnumber ">2.1.0</span></div><div><h2 class="title"><span class="number">19 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Cloud Controller Database Secret Rotation</span> <a title="Permalink" class="permalink" href="cha-cap-ccdb-secret-rotation.html#">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_ccdb_key_rotation.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="cha-cap-ccdb-secret-rotation.html#sec-cap-ccdb-tables"><span class="number">19.1 </span><span class="name">Tables with Encrypted Information</span></a></span></dt></dl></div></div><p>
  The Cloud Controller Database (CCDB) encrypts sensitive information like
  passwords. The encryption key is generated when KubeCF is deployed.
  If it is compromised or needs to be rotated for any other reason, new keys can be
  added. Note that existing encrypted information will not be updated. The
  encrypted information must be set again to have them re-encrypted with the
  new key. The old key cannot be dropped until all references to it are removed
  from the database.
 </p><p>
  Updating these secrets is a manual process that involves decrypting the
  current contents of the database using the old key and re-encrypting the
  contents using a new key. The following procedure outlines
  how this is done.
 </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
    For each label under <code class="literal">key_labels</code>, KubeCF will generate
    an encryption key. The <code class="literal">current_key_label</code> indicates which
    key is currently being used.
   </p><div class="verbatim-wrap"><pre class="screen">ccdb:
  encryption:
    rotation:
      key_labels:
      - <em class="replaceable ">encryption_key_0</em>
      current_key_label: <em class="replaceable ">encryption_key_0</em></pre></div></li><li class="step "><p>
    In order to rotate the CCDB encryption key, add a new label to
    <code class="literal">key_labels</code> (keeping the old labels), and mark
    the <code class="literal">current_key_label</code> with the newly added label:
   </p><div class="verbatim-wrap"><pre class="screen">ccdb:
  encryption:
    rotation:
      key_labels:
      - <em class="replaceable ">encryption_key_0</em>
      - <em class="replaceable ">encryption_key_1</em>
      current_key_label: <em class="replaceable ">encryption_key_1</em></pre></div></li><li class="step "><p>
    Save the above information into a file, for example
    <em class="replaceable ">rotate-secret.yaml</em>, and perform the rotation:
   </p><ol type="a" class="substeps "><li class="step "><p>
      Update the KubeCF Helm installation:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade kubecf --namespace <em class="replaceable ">kubecf</em> --values <em class="replaceable ">rotate-secret.yaml</em> --reuse-values</pre></div></li><li class="step "><p>
      After Helm finishes its updates, trigger the
      <code class="literal">rotate-cc-database-key</code> errand:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl patch qjob kubecf-rotate-cc-database-key \
--namespace <em class="replaceable ">kubecf</em> \
--type merge \
--patch '{"spec":{"trigger":{"strategy":"now"}}}'</pre></div></li></ol></li></ol></div></div><div class="sect1 " id="sec-cap-ccdb-tables"><div class="titlepage"><div><div><h2 class="title"><span class="number">19.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Tables with Encrypted Information</span> <a title="Permalink" class="permalink" href="cha-cap-ccdb-secret-rotation.html#sec-cap-ccdb-tables">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_ccdb_key_rotation.xml</li><li><span class="ds-label">ID: </span>sec-cap-ccdb-tables</li></ul></div></div></div></div><p>
   The CCDB contains several tables with encrypted information as follows:
  </p><div class="variablelist "><dl class="variablelist"><dt id="id-1.3.5.9.5.3.1"><span class="term ">apps</span></dt><dd><p>
      Environment variables
     </p></dd><dt id="id-1.3.5.9.5.3.2"><span class="term ">buildpack_lifecycle_buildpacks</span></dt><dd><p>
      Buildpack URLs may contain passwords
     </p></dd><dt id="id-1.3.5.9.5.3.3"><span class="term ">buildpack_lifecycle_data</span></dt><dd><p>
      Buildpack URLs may contain passwords
     </p></dd><dt id="id-1.3.5.9.5.3.4"><span class="term ">droplets</span></dt><dd><p>
      May contain Docker registry passwords
     </p></dd><dt id="id-1.3.5.9.5.3.5"><span class="term ">env_groups</span></dt><dd><p>
      Environment variables
     </p></dd><dt id="id-1.3.5.9.5.3.6"><span class="term ">packages</span></dt><dd><p>
      May contain Docker registry passwords
     </p></dd><dt id="id-1.3.5.9.5.3.7"><span class="term ">service_bindings</span></dt><dd><p>
      Contains service credentials
     </p></dd><dt id="id-1.3.5.9.5.3.8"><span class="term ">service_brokers</span></dt><dd><p>
      Contains service credentials
     </p></dd><dt id="id-1.3.5.9.5.3.9"><span class="term ">service_instances</span></dt><dd><p>
      Contains service credentials
     </p></dd><dt id="id-1.3.5.9.5.3.10"><span class="term ">service_keys</span></dt><dd><p>
      Contains service credentials
     </p></dd><dt id="id-1.3.5.9.5.3.11"><span class="term ">tasks</span></dt><dd><p>
      Environment variables
     </p></dd></dl></div><div class="sect2 " id="sec-cap-ccdb-update-existing-table-data"><div class="titlepage"><div><div><h3 class="title"><span class="number">19.1.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Update Existing Data with New Encryption Key</span> <a title="Permalink" class="permalink" href="cha-cap-ccdb-secret-rotation.html#sec-cap-ccdb-update-existing-table-data">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_ccdb_key_rotation.xml</li><li><span class="ds-label">ID: </span>sec-cap-ccdb-update-existing-table-data</li></ul></div></div></div></div><p>
    To ensure the encryption key is updated for existing data, the command (or
    its <code class="command">update-</code> equivalent) can be run again with the same
    parameters. Some commands need to be deleted/recreated to update the label.
   </p><div class="variablelist "><dl class="variablelist"><dt id="id-1.3.5.9.5.4.3.1"><span class="term ">apps</span></dt><dd><p>
       Run <code class="command">cf set-env</code> again
      </p></dd><dt id="id-1.3.5.9.5.4.3.2"><span class="term ">buildpack_lifecycle_buildpacks, buildpack_lifecycle_data, droplets</span></dt><dd><p>
       <code class="command">cf restage</code> the app
      </p></dd><dt id="id-1.3.5.9.5.4.3.3"><span class="term ">packages</span></dt><dd><p>
       <code class="command">cf delete</code>, then <code class="command">cf push</code> the app
       (Docker apps with registry password)
      </p></dd><dt id="id-1.3.5.9.5.4.3.4"><span class="term ">env_groups</span></dt><dd><p>
       Run <code class="command">cf set-staging-environment-variable-group</code> or
       <code class="command">cf set-running-environment-variable-group</code> again
      </p></dd><dt id="id-1.3.5.9.5.4.3.5"><span class="term ">service_bindings</span></dt><dd><p>
       Run <code class="command">cf unbind-service</code> and <code class="command">cf
       bind-service</code> again
      </p></dd><dt id="id-1.3.5.9.5.4.3.6"><span class="term ">service_brokers</span></dt><dd><p>
       Run <code class="command">cf update-service-broker</code> with the appropriate
       credentials
      </p></dd><dt id="id-1.3.5.9.5.4.3.7"><span class="term ">service_instances</span></dt><dd><p>
       Run <code class="command">cf update-service</code> with the appropriate
       credentials
      </p></dd><dt id="id-1.3.5.9.5.4.3.8"><span class="term ">service_keys</span></dt><dd><p>
       Run <code class="command">cf delete-service-key</code> and <code class="command">cf
       create-service-key</code> again
      </p></dd><dt id="id-1.3.5.9.5.4.3.9"><span class="term ">tasks</span></dt><dd><p>
       While tasks have an encryption key label, they are generally meant to be
       a one-off event, and left to run to completion. If there is a task still
       running, it could be stopped with <code class="command">cf terminate-task</code>,
       then run again with <code class="command">cf run-task</code>.
      </p></dd></dl></div></div></div></div></div><div class="page-bottom"><div id="_bottom-navigation"><a class="nav-link" href="cha-cap-secrets-rotation.html"><span class="next-icon">→</span><span class="nav-label"><span class="number">Chapter 20 </span>Rotating Automatically Generated Secrets</span></a><a class="nav-link" href="cha-cap-memory-limits.html"><span class="prev-icon">←</span><span class="nav-label"><span class="number">Chapter 18 </span>Container Memory Limits and Requests</span></a></div><div class="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span class="_share-fb bottom-button">Facebook</span><span class="spacer"> • </span><span class="_share-in bottom-button">LinkedIn</span><span class="spacer"> • </span><span class="_share-tw bottom-button">Twitter</span><span class="spacer"> • </span><span class="_share-mail bottom-button">E-Mail</span></span></div><div class="print"><span class="_print-button bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2021 
        SUSE</p><ul><li><a href="https://jobs.suse.com/" target="_top">Careers</a></li><li><a href="https://www.suse.com/company/legal/" target="_top">Legal</a></li><li><a href="https://www.suse.com/company/about/" target="_top">About</a></li><li><a href="https://www.suse.com/contact/" target="_top">Contact Us</a></li></ul></div></div></body></html>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Backup and Restore | Deployment, Administration, and User Guides | SUSE Cloud Application Platform 2.1.1</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" /><meta name="generator" content="DAPS 3.2.0 (https://opensuse.github.io/daps) using SUSE XSL Stylesheets 2.81.0 (based on DocBook XSL Stylesheets 1.79.2) - chunked" /><meta name="product-name" content="SUSE Cloud Application Platform" /><meta name="product-number" content="2.1.1" /><meta name="book-title" content="Deployment, Administration, and User Guides" /><meta name="chapter-title" content="Chapter 21. Backup and Restore" /><meta name="description" content="cf-plugin-backup backs up and restores your Cloud Controller Database (CCDB), using the Cloud Foundry command line interface (cf CLI). (See Section 26.1, “Using the cf CLI with SUSE Cloud Application Platform”.)" /><meta name="tracker-url" content="https://github.com/SUSE/doc-cap/issues/new" /><meta name="tracker-type" content="gh" /><meta name="tracker-gh-assignee" content="btat" /><meta name="tracker-gh-labels" content="bug,low priority" /><link rel="home" href="index.html" title="SUSE Cloud Application Platform 2.1.1 Documentation" /><link rel="up" href="part-cap-administration.html" title="Part III. SUSE Cloud Application Platform Administration" /><link rel="prev" href="cha-cap-secrets-rotation.html" title="Chapter 20. Rotating Automatically Generated Secrets" /><link rel="next" href="cha-cap-service-brokers.html" title="Chapter 22. Service Brokers" />
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css"></link>');
}
else {
  document.write('<link rel="stylesheet" type="text/css" href="static/css/fonts-onlylocal.css"></link>');
}

</script><noscript><link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css" /></noscript><script src="static/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-navigation">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><div id="_outer-wrap"><div id="_white-bg" style="background-color: #E11;"><div id="_header"><div id="_logo"><img src="static/images/logo.png" alt="Logo" /></div><div class="crumbs"><a class="book-link" href="index.html" title="SUSE Cloud Application Platform 2.1.1 Documentation"><span class="book-icon">SUSE Cloud Application Platform 2.1.1 Documentation</span></a><span> › </span><a class="crumb" href="book-cap-guides.html">Deployment, Administration, and User Guides</a><span> › </span><a class="crumb" href="part-cap-administration.html">SUSE Cloud Application Platform Administration</a><span> › </span><a class="crumb" href="cha-cap-backup-restore.html">Backup and Restore</a></div><div class="clearme"></div></div></div><div id="_toolbar-wrap"><div id="_toolbar"><div id="_toc-area" class="inactive"><a id="_toc-area-button" class="tool" title="Contents" accesskey="c" href="index.html"><span class="tool-spacer"><span class="toc-icon">Contents</span><span class="clearme"></span></span><span class="tool-label">Contents</span></a><div class="active-contents bubble-corner"></div><div class="active-contents bubble"><div class="bubble-container"><h6>Deployment, Administration, and User Guides</h6><div id="_bubble-toc"><ol><li class="inactive"><a href="preface-deployment.html"><span class="number"> </span><span class="name">About This Guide</span></a></li><li class="inactive"><a href="part-cap-overview.html"><span class="number">I </span><span class="name">Overview of SUSE Cloud Application Platform</span></a><ol><li class="inactive"><a href="cha-cap-overview.html"><span class="number">1 </span><span class="name">About SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-depl-kube-requirements.html"><span class="number">2 </span><span class="name">Other Kubernetes Systems</span></a></li></ol></li><li class="inactive"><a href="part-cap-deployment.html"><span class="number">II </span><span class="name">Deploying SUSE Cloud Application Platform</span></a><ol><li class="inactive"><a href="cha-cap-depl-notes.html"><span class="number">3 </span><span class="name">Deployment and Administration Notes</span></a></li><li class="inactive"><a href="cha-cap-depl-caasp.html"><span class="number">4 </span><span class="name">Deploying SUSE Cloud Application Platform on SUSE CaaS Platform</span></a></li><li class="inactive"><a href="cha-cap-depl-aks.html"><span class="number">5 </span><span class="name">Deploying SUSE Cloud Application Platform on Microsoft Azure Kubernetes Service (AKS)</span></a></li><li class="inactive"><a href="cha-cap-depl-eks.html"><span class="number">6 </span><span class="name">Deploying SUSE Cloud Application Platform on Amazon Elastic Kubernetes Service (EKS)</span></a></li><li class="inactive"><a href="cha-cap-depl-gke.html"><span class="number">7 </span><span class="name">Deploying SUSE Cloud Application Platform on Google Kubernetes Engine (GKE)</span></a></li><li class="inactive"><a href="cha-cap-install-stratos.html"><span class="number">8 </span><span class="name">Installing the Stratos Web Console</span></a></li><li class="inactive"><a href="cha-cap-depl-eirini.html"><span class="number">9 </span><span class="name">Eirini</span></a></li><li class="inactive"><a href="cha-cap-depl-terraform.html"><span class="number">10 </span><span class="name">Deploying SUSE Cloud Application Platform Using Terraform</span></a></li><li class="inactive"><a href="cha-cap-depl-air-gap-registry.html"><span class="number">11 </span><span class="name">Setting Up a Registry for an Air Gapped Environment</span></a></li><li class="inactive"><a href="cha-cap-depl-private-registry.html"><span class="number">12 </span><span class="name">SUSE Private Registry</span></a></li></ol></li><li class="inactive"><a href="part-cap-administration.html"><span class="number">III </span><span class="name">SUSE Cloud Application Platform Administration</span></a><ol><li class="inactive"><a href="cha-cap-upgrade.html"><span class="number">13 </span><span class="name">Upgrading SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-configuration-changes.html"><span class="number">14 </span><span class="name">Configuration Changes</span></a></li><li class="inactive"><a href="cha-cap-create-admin-user.html"><span class="number">15 </span><span class="name">Creating Admin Users</span></a></li><li class="inactive"><a href="cha-cap-manage-passwords.html"><span class="number">16 </span><span class="name">Managing Passwords</span></a></li><li class="inactive"><a href="cha-cap-uaa-ui.html"><span class="number">17 </span><span class="name">Accessing the UAA User Interface</span></a></li><li class="inactive"><a href="cha-cap-memory-limits.html"><span class="number">18 </span><span class="name">Container Memory Limits and Requests</span></a></li><li class="inactive"><a href="cha-cap-ccdb-secret-rotation.html"><span class="number">19 </span><span class="name">Cloud Controller Database Secret Rotation</span></a></li><li class="inactive"><a href="cha-cap-secrets-rotation.html"><span class="number">20 </span><span class="name">Rotating Automatically Generated Secrets</span></a></li><li class="inactive"><a href="cha-cap-backup-restore.html"><span class="number">21 </span><span class="name">Backup and Restore</span></a></li><li class="inactive"><a href="cha-cap-service-brokers.html"><span class="number">22 </span><span class="name">Service Brokers</span></a></li><li class="inactive"><a href="cha-cap-app-autoscaler.html"><span class="number">23 </span><span class="name">App-AutoScaler</span></a></li><li class="inactive"><a href="cha-cap-credhub.html"><span class="number">24 </span><span class="name">Integrating CredHub with SUSE Cloud Application Platform</span></a></li><li class="inactive"><a href="cha-cap-buildpacks.html"><span class="number">25 </span><span class="name">Buildpacks</span></a></li></ol></li><li class="inactive"><a href="part-cap-user-guide.html"><span class="number">IV </span><span class="name">SUSE Cloud Application Platform User Guide</span></a><ol><li class="inactive"><a href="cha-cap-cf-cli.html"><span class="number">26 </span><span class="name">Deploying and Managing Applications with the Cloud Foundry Client</span></a></li></ol></li><li class="inactive"><a href="part-cap-troubleshooting.html"><span class="number">V </span><span class="name">Troubleshooting</span></a><ol><li class="inactive"><a href="cha-cap-depl-troubleshooting.html"><span class="number">27 </span><span class="name">Troubleshooting</span></a></li></ol></li><li class="inactive"><a href="bk01apa.html"><span class="number">A </span><span class="name">Appendix</span></a></li><li class="inactive"><a href="bk01apb.html"><span class="number">B </span><span class="name">GNU Licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_nav-area" class="inactive"><div class="tool"><span class="nav-inner"><span class="tool-label">Navigation</span><a accesskey="p" class="tool-spacer" title="Chapter 20. Rotating Automatically Generated Secrets" href="cha-cap-secrets-rotation.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 22. Service Brokers" href="cha-cap-service-brokers.html"><span class="next-icon">→</span></a></span></div></div></div></div><div id="_fixed-header-wrap" style="background-color: #E11;" class="inactive"><div id="_fixed-header"><div class="crumbs"><a class="book-link" href="index.html" title="SUSE Cloud Application Platform 2.1.1 Documentation"><span class="book-icon">SUSE Cloud Application Platform 2.1.1 Documentation</span></a><span> › </span><a class="crumb" href="book-cap-guides.html">Deployment, Administration, and User Guides</a><span> › </span><a class="crumb" href="part-cap-administration.html">SUSE Cloud Application Platform Administration</a><span> › </span><a class="crumb" href="cha-cap-backup-restore.html">Backup and Restore</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="button"><a accesskey="p" class="tool-spacer" title="Chapter 20. Rotating Automatically Generated Secrets" href="cha-cap-secrets-rotation.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 22. Service Brokers" href="cha-cap-service-brokers.html"><span class="next-icon">→</span></a></div><div class="clearme"></div></div><div class="clearme"></div></div></div><div id="_content" class="draft "><div class="documentation"><div class="chapter " id="cha-cap-backup-restore"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname ">SUSE Cloud Application Platform</span> <span class="productnumber ">2.1.1</span></div><div><h2 class="title"><span class="number">21 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Backup and Restore</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="cha-cap-backup-restore.html#sec-cap-backup-restore-with-plugin"><span class="number">21.1 </span><span class="name">Backup and Restore Using cf-plugin-backup</span></a></span></dt><dt><span class="sect1"><a href="cha-cap-backup-restore.html#sec-cap-backup-restore-of-raw-data"><span class="number">21.2 </span><span class="name">Disaster Recovery through Raw Data Backup and Restore</span></a></span></dt></dl></div></div><div class="sect1 " id="sec-cap-backup-restore-with-plugin"><div class="titlepage"><div><div><h2 class="title"><span class="number">21.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Backup and Restore Using cf-plugin-backup</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-backup-restore-with-plugin">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-backup-restore-with-plugin</li></ul></div></div></div></div><p>
   <code class="literal">cf-plugin-backup</code> backs up and restores your Cloud
   Controller Database (CCDB), using the Cloud Foundry command line interface (cf CLI).
   (See <a class="xref" href="cha-cap-cf-cli.html#sec-cap-cf-cli" title="26.1. Using the cf CLI with SUSE Cloud Application Platform">Section 26.1, “Using the cf CLI with SUSE Cloud Application Platform”</a>.)
  </p><p>
   <code class="literal">cf-plugin-backup</code> is not a general-purpose backup and
   restore plugin. It is designed to save the state of a KubeCF instance before
   making changes to it. If the changes cause problems, use
   <code class="literal">cf-plugin-backup</code> to restore the instance from scratch. Do
   not use it to restore to a non-pristine KubeCF instance. Some of the
   limitations for applying the backup to a non-pristine KubeCF instance are:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Application configuration is not restored to running applications, as the
     plugin does not have the ability to determine which applications should be
     restarted to load the restored configurations.
    </p></li><li class="listitem "><p>
     User information is managed by the User Account and Authentication (<code class="literal">uaa</code>) Server,
     not the Cloud Controller (CC). As the plugin talks only to the CC it cannot
     save full user information, nor restore users. Saving and restoring users
     must be performed separately, and user restoration must be performed before
     the backup plugin is invoked.
    </p></li><li class="listitem "><p>
     The set of available stacks is part of the KubeCF instance setup, and is
     not part of the CC configuration. Trying to restore applications using
     stacks not available on the target KubeCF instance will fail. Setting up
     the necessary stacks must be performed separately before the backup plugin
     is invoked.
    </p></li><li class="listitem "><p>
     Buildpacks are not saved. Applications using custom buildpacks not
     available on the target KubeCF instance will not be restored.
     Custom buildpacks must be managed separately, and relevant buildpacks must
     be in place before the affected applications are restored.
    </p></li></ul></div><div class="sect2 " id="sec-cap-install-backup-restore-plugin"><div class="titlepage"><div><div><h3 class="title"><span class="number">21.1.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Installing the cf-plugin-backup</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-install-backup-restore-plugin">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-install-backup-restore-plugin</li></ul></div></div></div></div><p>
    Download the plugin from
    <a class="link" href="https://github.com/SUSE/cf-plugin-backup/releases" target="_blank">https://github.com/SUSE/cf-plugin-backup/releases</a>.
   </p><p>
    Then install it with <code class="command">cf</code>, using the name of the plugin
    binary that you downloaded:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf install-plugin <em class="replaceable ">cf-plugin-backup-1.0.8.0.g9e8438e.linux-amd64</em>
 Attention: Plugins are binaries written by potentially untrusted authors.
 Install and use plugins at your own risk.
 Do you want to install the plugin
 backup-plugin/cf-plugin-backup-1.0.8.0.g9e8438e.linux-amd64? [yN]: y
 Installing plugin backup...
 OK
 Plugin backup 1.0.8 successfully installed.</pre></div><p>
    Verify installation by listing installed plugins:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf plugins
 Listing installed plugins...

 plugin   version   command name      command help
 backup   1.0.8     backup-info       Show information about the current snapshot
 backup   1.0.8     backup-restore    Restore the CloudFoundry state from a
  backup created with the snapshot command
 backup   1.0.8     backup-snapshot   Create a new CloudFoundry backup snapshot
  to a local file

 Use 'cf repo-plugins' to list plugins in registered repos available to install.</pre></div></div><div class="sect2 " id="sec-cap-using-backup-restore-plugin"><div class="titlepage"><div><div><h3 class="title"><span class="number">21.1.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Using cf-plugin-backup</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-using-backup-restore-plugin">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-using-backup-restore-plugin</li></ul></div></div></div></div><p>
    The plugin has three commands:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      backup-info
     </p></li><li class="listitem "><p>
      backup-snapshot
     </p></li><li class="listitem "><p>
      backup-restore
     </p></li></ul></div><p>
    View the online help for any command, like this example:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code> cf backup-info --help
 NAME:
   backup-info - Show information about the current snapshot

 USAGE:
   cf backup-info</pre></div><p>
    Create a backup of your SUSE Cloud Application Platform data and applications. The command
    outputs progress messages until it is completed:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf backup-snapshot
 2018/08/18 12:48:27 Retrieving resource /v2/quota_definitions
 2018/08/18 12:48:30 org quota definitions done
 2018/08/18 12:48:30 Retrieving resource /v2/space_quota_definitions
 2018/08/18 12:48:32 space quota definitions done
 2018/08/18 12:48:32 Retrieving resource /v2/organizations
 [...]</pre></div><p>
    Your Cloud Application Platform data is saved in the current directory in
    <code class="filename">cf-backup.json</code>, and application data in the
    <code class="filename">app-bits/</code> directory.
   </p><p>
    View the current backup:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf backup-info
 - Org  system</pre></div><p>
    Restore from backup:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cf backup-restore</pre></div><p>
    There are two additional restore options:
    <code class="command">--include-security-groups</code> and
    <code class="command">--include-quota-definitions</code>.
   </p></div><div class="sect2 " id="sec-cap-backup-restore-plugin-scope"><div class="titlepage"><div><div><h3 class="title"><span class="number">21.1.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Scope of Backup</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-backup-restore-plugin-scope">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-backup-restore-plugin-scope</li></ul></div></div></div></div><p>
    The following table lists the scope of the
    <code class="literal">cf-plugin-backup</code> backup. Organization and space users
    are backed up at the SUSE Cloud Application Platform level. The user account in
    <code class="literal">uaa</code>/LDAP, the service instances and their application
    bindings, and buildpacks are not backed up. The sections following the
    table goes into more detail.
   </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>Scope</th><th>Restore</th></tr></thead><tbody><tr><td>Orgs</td><td>Yes</td></tr><tr><td>Org auditors</td><td>Yes</td></tr><tr><td>Org billing-manager</td><td>Yes</td></tr><tr><td>Quota definitions</td><td>Optional</td></tr><tr><td>Spaces</td><td>Yes</td></tr><tr><td>Space developers</td><td>Yes</td></tr><tr><td>Space auditors</td><td>Yes</td></tr><tr><td>Space managers</td><td>Yes</td></tr><tr><td>Apps</td><td>Yes</td></tr><tr><td>App binaries</td><td>Yes</td></tr><tr><td>Routes</td><td>Yes</td></tr><tr><td>Route mappings</td><td>Yes</td></tr><tr><td>Domains</td><td>Yes</td></tr><tr><td>Private domains</td><td>Yes</td></tr><tr><td>Stacks</td><td>not available</td></tr><tr><td>Feature flags</td><td>Yes</td></tr><tr><td>Security groups</td><td>Optional</td></tr><tr><td>Custom buildpacks</td><td>No</td></tr></tbody></table></div><p>
    <code class="command">cf backup-info</code> reads the
    <code class="filename">cf-backup.json</code> snapshot file found in the current
    working directory, and reports summary statistics on the content.
   </p><p>
    <code class="command">cf backup-snapshot</code> extracts and saves the following
    information from the CC into a <code class="filename">cf-backup.json</code> snapshot
    file. Note that it does not save user information, but only the references
    needed for the roles. The full user information is handled by the
    <code class="literal">uaa</code> server, and the plugin talks only to the CC. The
    following list provides a summary of what each plugin command does.
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      Org Quota Definitions
     </p></li><li class="listitem "><p>
      Space Quota Definitions
     </p></li><li class="listitem "><p>
      Shared Domains
     </p></li><li class="listitem "><p>
      Security Groups
     </p></li><li class="listitem "><p>
      Feature Flags
     </p></li><li class="listitem "><p>
      Application droplets (zip files holding the staged app)
     </p></li><li class="listitem "><p>
      Orgs
     </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
        Spaces
       </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
          Applications
         </p></li><li class="listitem "><p>
          Users' references (role in the space)
         </p></li></ul></div></li></ul></div></li></ul></div><p>
    <code class="command">cf backup-restore</code> reads the
    <code class="filename">cf-backup.json</code> snapshot file found in the current
    working directory, and then talks to the targeted KubeCF instance to upload
    the following information, in the specified order:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      Shared domains
     </p></li><li class="listitem "><p>
      Feature flags
     </p></li><li class="listitem "><p>
      Quota Definitions (iff --include-quota-definitions)
     </p></li><li class="listitem "><p>
      Orgs
     </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
        Space Quotas (iff --include-quota-definitions)
       </p></li><li class="listitem "><p>
        UserRoles
       </p></li><li class="listitem "><p>
        (private) Domains
       </p></li><li class="listitem "><p>
        Spaces
       </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
          UserRoles
         </p></li><li class="listitem "><p>
          Applications (+ droplet)
         </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
            Bound Routes
           </p></li></ul></div></li><li class="listitem "><p>
          Security Groups (iff --include-security-groups)
         </p></li></ul></div></li></ul></div></li></ul></div><p>
    The following list provides more details of each action.
   </p><div class="variablelist "><dl class="variablelist"><dt id="id-1.3.5.11.2.7.10.1"><span class="term ">Shared Domains</span></dt><dd><p>
       Attempts to create domains from the backup. Existing domains are
       retained, and not overwritten.
      </p></dd><dt id="id-1.3.5.11.2.7.10.2"><span class="term ">Feature Flags</span></dt><dd><p>
       Attempts to update flags from the backup.
      </p></dd><dt id="id-1.3.5.11.2.7.10.3"><span class="term ">Quota Definitions</span></dt><dd><p>
       Existing quotas are overwritten from the backup (deleted, re-created).
      </p></dd><dt id="id-1.3.5.11.2.7.10.4"><span class="term ">Orgs</span></dt><dd><p>
       Attempts to create orgs from the backup. Attempts to update existing
       orgs from the backup.
      </p></dd><dt id="id-1.3.5.11.2.7.10.5"><span class="term ">Space Quota Definitions</span></dt><dd><p>
       Existing quotas are overwritten from the backup (deleted, re-created).
      </p></dd><dt id="id-1.3.5.11.2.7.10.6"><span class="term ">User roles</span></dt><dd><p>
       Expect the referenced user to exist. Will fail when the user is already
       associated with the space, in the given role.
      </p></dd><dt id="id-1.3.5.11.2.7.10.7"><span class="term ">(private) Domains</span></dt><dd><p>
       Attempts to create domains from the backup. Existing domains are
       retained, and not overwritten.
      </p></dd><dt id="id-1.3.5.11.2.7.10.8"><span class="term ">Spaces</span></dt><dd><p>
       Attempts to create spaces from the backup. Attempts to update existing
       spaces from the backup.
      </p></dd><dt id="id-1.3.5.11.2.7.10.9"><span class="term ">User roles</span></dt><dd><p>
       Expect the referenced user to exist. Will fail when the user is already
       associated with the space, in the given role.
      </p></dd><dt id="id-1.3.5.11.2.7.10.10"><span class="term ">Apps</span></dt><dd><p>
       Attempts to create apps from the backup. Attempts to update existing
       apps from the backup (memory, instances, buildpack, state, ...)
      </p></dd><dt id="id-1.3.5.11.2.7.10.11"><span class="term ">Security groups</span></dt><dd><p>
       Existing groups are overwritten from the backup
      </p></dd></dl></div></div></div><div class="sect1 " id="sec-cap-backup-restore-of-raw-data"><div class="titlepage"><div><div><h2 class="title"><span class="number">21.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Disaster Recovery through Raw Data Backup and Restore</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-backup-restore-of-raw-data">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-backup-restore-of-raw-data</li></ul></div></div></div></div><p>
   An existing SUSE Cloud Application Platform deployment's data can be migrated to a new
   SUSE Cloud Application Platform deployment through a backup and restore of its raw data. The
   process involves performing a backup and restore of the
   <code class="literal">kubecf</code> components respectively. This procedure is agnostic of
   the underlying Kubernetes infrastructure and can be included as part of your
   disaster recovery solution.
  </p><div class="sect2 " id="sec-cap-raw-data-prerequisites"><div class="titlepage"><div><div><h3 class="title"><span class="number">21.2.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Prerequisites</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-raw-data-prerequisites">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-raw-data-prerequisites</li></ul></div></div></div></div><p>
    In order to complete a raw data backup and restore, the following are
    required:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      Access to a running deployment of <code class="literal">kubecf</code> to create backups
      with
     </p></li><li class="listitem "><p>
      Access to a new deployment of <code class="literal">kubecf</code> (deployed with a
      <code class="filename">kubecf-config-values.yaml</code> configured according to
      <a class="xref" href="cha-cap-backup-restore.html#prepare-config-for-new-cluster" title="Step 1">Step 1</a> of
      <a class="xref" href="cha-cap-backup-restore.html#sec-cap-raw-data-restore-procedure" title="21.2.4. Performing a Raw Data Restore">Section 21.2.4, “Performing a Raw Data Restore”</a>) to perform the
      restore to
     </p></li></ul></div></div><div class="sect2 " id="sec-cap-raw-data-scope"><div class="titlepage"><div><div><h3 class="title"><span class="number">21.2.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Scope of Raw Data Backup and Restore</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-raw-data-scope">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-raw-data-scope</li></ul></div></div></div></div><p>
    The following lists the data that is included as part of the backup (and
    restore) procedure:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      The Cloud Controller Database (CCDB). In addition to what is encompassed
      by the CCDB listed in
      <a class="xref" href="cha-cap-backup-restore.html#sec-cap-backup-restore-plugin-scope" title="21.1.3. Scope of Backup">Section 21.1.3, “Scope of Backup”</a>, this will include
      service binding data as well.
     </p></li><li class="listitem "><p>
      The Cloud Controller blobstore, which includes the types of binary large
      object (blob) files listed below. (See
      <a class="link" href="https://docs.cloudfoundry.org/concepts/architecture/cloud-controller.html#blob-store" target="_blank">https://docs.cloudfoundry.org/concepts/architecture/cloud-controller.html#blob-store</a>
      to learn more about each blob type.)
     </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
        App Packages
       </p></li><li class="listitem "><p>
        Buildpacks
       </p></li><li class="listitem "><p>
        Resource Cache
       </p></li><li class="listitem "><p>
        Buildpack Cache
       </p></li><li class="listitem "><p>
        Droplets
       </p></li></ul></div></li><li class="listitem "><p>
      User data
     </p></li></ul></div></div><div class="sect2 " id="sec-cap-raw-data-backup-procedure"><div class="titlepage"><div><div><h3 class="title"><span class="number">21.2.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Performing a Raw Data Backup</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-raw-data-backup-procedure">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-raw-data-backup-procedure</li></ul></div></div></div></div><div id="id-1.3.5.11.3.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Restore to the Same Version</h6><p>
     This process is intended for backing up and restoring to a target
     deployment with the same version as the source deployment. For example,
     data from a backup of SUSE Cloud Application Platform 2.1.1 should be restored to a
     SUSE Cloud Application Platform 2.1.1 deployment.
    </p></div><p>
    Perform the following steps to create a backup of your source
    SUSE Cloud Application Platform deployment.
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Export the blobstore into a file.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --namespace kubecf singleton-blobstore-0 --
tar cfz - --exclude=/var/vcap/store/shared/tmp /var/vcap/store/shared &gt;
blob.tgz</pre></div></li><li class="step "><p>
      The current UAA database configuration does not allow exporting of a
      mysqldump, so need to be more permissive.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cat &lt;&lt;EOF | kubectl exec --stdin database-0 --namespace kubecf
-- mysql
SET GLOBAL pxc_strict_mode=PERMISSIVE;
SET GLOBAL
sql_mode='STRICT_ALL_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
set GLOBAL innodb_strict_mode='OFF';
EOF</pre></div></li><li class="step "><p>
      Export the UAA database into a file.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin database-0 --namespace kubecf --
mysqldump uaa &gt; uaadb-src.sql</pre></div></li><li class="step "><p>
      Export the Cloud Controller Database (CCDB) into a file.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin database-0 --namespace kubecf --
mysqldump cloud_controller &gt; ccdb-src.sql</pre></div></li><li class="step " id="get-encryption-key"><p>
      Save the CCDB encryption key(s). Adjust the <code class="command">A</code> flag as
      needed to include all keys.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin --tty --namespace kubecf api-0 -- bash
-c "cat /var/vcap/jobs/cloud_controller_ng/config/cloud_controller_ng.yml | grep
-A 10 db_encryption" &gt; enc_key</pre></div></li></ol></div></div></div><div class="sect2 " id="sec-cap-raw-data-restore-procedure"><div class="titlepage"><div><div><h3 class="title"><span class="number">21.2.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Performing a Raw Data Restore</span> <a title="Permalink" class="permalink" href="cha-cap-backup-restore.html#sec-cap-raw-data-restore-procedure">#</a></h3><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>cap_admin_backup-restore.xml</li><li><span class="ds-label">ID: </span>sec-cap-raw-data-restore-procedure</li></ul></div></div></div></div><div id="id-1.3.5.11.3.6.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Ensure Access to the Correct Deployment</h6><p>
     Working with multiple Kubernetes clusters simultaneously can be confusing.
     Ensure you are communicating with the desired cluster
     <a class="link" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/#set-the-kubeconfig-environment-variable" target="_blank">by
     setting <code class="literal">$KUBECONFIG</code> correctly</a>.
    </p></div><p>
    Perform the following steps to restore your backed up data to the target
    SUSE Cloud Application Platform deployment.
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step " id="prepare-config-for-new-cluster"><p>
      Deploy the target SUSE Cloud Application Platform cluster following the steps for your
      platform.
     </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
    For SUSE® CaaS Platform, see <a class="xref" href="cha-cap-depl-caasp.html" title="Chapter 4. Deploying SUSE Cloud Application Platform on SUSE CaaS Platform">Chapter 4, <em>Deploying SUSE Cloud Application Platform on SUSE CaaS Platform</em></a>.
   </p></li><li class="listitem "><p>
    For Microsoft Azure Kubernetes Service, see <a class="xref" href="cha-cap-depl-aks.html" title="Chapter 5. Deploying SUSE Cloud Application Platform on Microsoft Azure Kubernetes Service (AKS)">Chapter 5, <em>Deploying SUSE Cloud Application Platform on Microsoft Azure Kubernetes Service (AKS)</em></a>.
   </p></li><li class="listitem "><p>
    For Amazon Elastic Kubernetes Service, see <a class="xref" href="cha-cap-depl-eks.html" title="Chapter 6. Deploying SUSE Cloud Application Platform on Amazon Elastic Kubernetes Service (EKS)">Chapter 6, <em>Deploying SUSE Cloud Application Platform on Amazon Elastic Kubernetes Service (EKS)</em></a>.
   </p></li><li class="listitem "><p>
    For Google Kubernetes Engine, see <a class="xref" href="cha-cap-depl-gke.html" title="Chapter 7. Deploying SUSE Cloud Application Platform on Google Kubernetes Engine (GKE)">Chapter 7, <em>Deploying SUSE Cloud Application Platform on Google Kubernetes Engine (GKE)</em></a>.
   </p></li></ul></div></li><li class="step "><p>
      The current UAA database configuration does not allow importing of a
      mysqldump, so needs to be made more permissive.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>cat &lt;&lt;EOF | kubectl exec --stdin database-0 --namespace kubecf
-- mysql
SET GLOBAL pxc_strict_mode=PERMISSIVE;
SET GLOBAL
sql_mode='STRICT_ALL_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
set GLOBAL innodb_strict_mode='OFF';
EOF</pre></div></li><li class="step "><p>
      Import the UAA database.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin database-0 --namespace kubecf -- mysql
uaa &lt; uaadb-src.sql</pre></div><p>
      Verify the import is successful. The output should list the users from the
      deployment the backup was taken from.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>echo "select username from uaa.users;" | kubectl exec -i
database-0 --namespace kubecf -- mysql</pre></div></li><li class="step "><p>
      Import the blobstore and restart the pod for changes to take affect.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin singleton-blobstore-0 --namespace kubecf -- tar xfz - -C
/ &lt; blob.tgz

<code class="prompt user">tux &gt; </code>kubectl delete pod --namespace kubecf singleton-blobstore-0</pre></div></li><li class="step "><p>
      Drop the current CCDB and create a new instance.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>echo "drop database cloud_controller; create database
cloud_controller;" | \
     kubectl exec -i database-0 --namespace kubecf -- mysql</pre></div></li><li class="step "><p>
      Import the CCDB.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kubectl exec --stdin database-0 --namespace kubecf -- mysql
cloud_controller &lt; ccdb-src.sql</pre></div></li><li class="step "><p>
      Update the encryption key.
     </p><ol type="a" class="substeps "><li class="step "><p>
        Create a YAML configuration file containing the encryption key
        information. The file structure should look similar to the following
        example, called <code class="filename">enc_key_values.yaml</code>. Replace 
        the example values using the values from the <code class="filename">enc_key</code>
        file generated earlier. Depending on the state of the cluster the
        encryption keys were retrieved from, the key labels may differ and not
        be <code class="literal">encryption_key_0</code>. 
       </p><div class="verbatim-wrap"><pre class="screen">ccdb:
  encryption:
    rotation:
      key_labels:
      - <em class="replaceable ">encryption_key_0</em>
      current_key_label: <em class="replaceable ">encryption_key_0</em>

credentials:
  cc_db_encryption_key:
<em class="replaceable ">elqdi7TARO6NYELa9cUr6WwMYIvqaG4U0nMyfL1loDYi02C1Rrneov6fxxfd64je</em>
  ccdb_key_label_<em class="replaceable ">encryption_key_0</em>:
<em class="replaceable ">tPhZZbMNYVWKs0II8e8pMxsJMokeReUrJAnQNdLaXEheTZVv5OpMe7vdyThhrkEP</em></pre></div><p>
        In the above, the key
        <code class="literal">credentials.ccdb_key_label_encryption_key_0</code> is
        based on the generic form
        <code class="literal">credentials.ccdb_key_label_XYZ</code>. The
        <code class="literal">XYZ</code> should be replaced with the value of the
        <code class="literal">current_key_label</code>.
       </p><p>
        For example, if the <code class="literal">current_key_label</code> is
        <code class="literal">new_key</code>, then
        <code class="literal">credentials.ccdb_key_label_new_key</code> should be used.
       </p></li><li class="step "><p>
        Perform a <code class="command">helm upgrade</code> for the changes to take
        affect.
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>helm upgrade <em class="replaceable ">kubecf</em> suse/kubecf
\
--namespace <em class="replaceable ">kubecf</em> \
--values kubecf-config-values.yaml \
--values <em class="replaceable ">enc_key_values.yaml</em> \
--version 2.7.13</pre></div></li></ol></li><li class="step "><p>
      When all pods are fully running, verify the restore is successful. Example
      commands to run include <code class="command">cf apps</code>,
      <code class="command">cf marketplace</code>, or <code class="command">cf services</code>.
     </p></li></ol></div></div></div></div></div></div><div class="page-bottom"><div id="_bottom-navigation"><a class="nav-link" href="cha-cap-service-brokers.html"><span class="next-icon">→</span><span class="nav-label"><span class="number">Chapter 22 </span>Service Brokers</span></a><a class="nav-link" href="cha-cap-secrets-rotation.html"><span class="prev-icon">←</span><span class="nav-label"><span class="number">Chapter 20 </span>Rotating Automatically Generated Secrets</span></a></div><div class="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span class="_share-fb bottom-button">Facebook</span><span class="spacer"> • </span><span class="_share-in bottom-button">LinkedIn</span><span class="spacer"> • </span><span class="_share-tw bottom-button">Twitter</span><span class="spacer"> • </span><span class="_share-mail bottom-button">E-Mail</span></span></div><div class="print"><span class="_print-button bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2021 
        SUSE</p><ul><li><a href="https://jobs.suse.com/" target="_top">Careers</a></li><li><a href="https://www.suse.com/company/legal/" target="_top">Legal</a></li><li><a href="https://www.suse.com/company/about/" target="_top">About</a></li><li><a href="https://www.suse.com/contact/" target="_top">Contact Us</a></li></ul></div></div></body></html>